<div class="processing-detail-page">
  @if (loading) {
  <div class="loading-state">
    <i class="pi pi-spin pi-spinner"></i>
    <span>Loading processing details...</span>
  </div>
  } @else if (processing) {

  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <p-button
        icon="pi pi-arrow-left"
        [text]="true"
        (click)="goBack()"
        pTooltip="Back to Processing List"
      >
      </p-button>
      <div class="header-info">
        <h1>DO Processing: {{ processing.doNumber }}</h1>
        <p-tag [severity]="getStatusSeverity(processing.status)" [value]="processing.status">
        </p-tag>
      </div>
    </div>
    <div class="header-actions">
      @if (isInProgress) {
      <p-button
        label="Cancel Processing"
        icon="pi pi-times"
        severity="danger"
        [text]="true"
        (click)="cancelProcessing()"
      >
      </p-button>
      }
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="steps-container">
    <p-steps [model]="steps" [activeIndex]="activeIndex" [readonly]="true"></p-steps>
  </div>

  <!-- Main Content Grid -->
  <div class="content-grid">
    <!-- Left Side: DO Information -->
    <div class="left-panel">
      <!-- DO Details Card -->
      <p-card header="Delivery Order Details">
        <div class="do-info-grid">
          <div class="info-item">
            <label>DO Number</label>
            <span>{{ processing.doNumber }}</span>
          </div>
          <div class="info-item">
            <label>Vendor</label>
            <span>{{ processing.vendorName || '-' }}</span>
          </div>
          <div class="info-item">
            <label>DO Date</label>
            <span>{{ processing.doDate | date : 'mediumDate' }}</span>
          </div>
          <div class="info-item">
            <label>Vehicle No</label>
            <span>{{ processing.vehicleNo || '-' }}</span>
          </div>
          <div class="info-item">
            <label>Transporter</label>
            <span>{{ processing.transporterName || '-' }}</span>
          </div>
          @if (processing.transporterGstin) {
          <div class="info-item">
            <label>Transporter GSTIN</label>
            <span>{{ processing.transporterGstin }}</span>
          </div>
          }
          <!-- RFID Card Info - visible in all steps -->
          <div class="info-item">
            <label>RFID Card</label>
            @if (processing.rfidCardId || assignedRfidCard) {
            <div class="rfid-info-display">
              <i class="pi pi-id-card text-green-500"></i>
              <span class="rfid-card-number">{{
                assignedRfidCard?.label || assignedRfidCard?.cardNumber || 'Assigned'
              }}</span>
            </div>
            } @else {
            <span class="text-gray-400">Not assigned</span>
            }
          </div>
        </div>
      </p-card>

      <!-- Weight Summary Card -->
      <p-card header="Weight Summary" class="mt-3">
        <div class="weight-grid">
          <div class="weight-item">
            <label>Initial Tare Weight (WB-1)</label>
            <span class="weight-value">
              {{
                processing.initialTareWeight
                  ? (+processing.initialTareWeight | number : '1.2-2') + ' kg'
                  : 'Not recorded'
              }}
            </span>
          </div>
          <div class="weight-item">
            <label>Total Loaded Weight</label>
            <span class="weight-value">
              {{
                processing.totalLoadedWeight
                  ? (+processing.totalLoadedWeight | number : '1.2-2') + ' kg'
                  : '0 kg'
              }}
            </span>
          </div>
          <div class="weight-item">
            <label>Final Gross Weight (WB-1)</label>
            <span class="weight-value">
              {{
                processing.finalGrossWeight
                  ? (+processing.finalGrossWeight | number : '1.2-2') + ' kg'
                  : 'Not recorded'
              }}
            </span>
          </div>
          <div class="weight-item">
            <label>Net Weight</label>
            <span class="weight-value highlight">
              {{ processing.netWeight ? (+processing.netWeight | number : '1.2-2') + ' kg' : '-' }}
            </span>
          </div>
        </div>
      </p-card>

      <!-- Live Weight Feed Card -->
      <p-card header="Live Weight Feed" class="mt-3">
        <div class="live-weight-feed">
          <div class="connection-status">
            <i
              class="pi"
              [class]="isDeviceBridgeConnected ? 'pi-wifi text-green-500' : 'pi-wifi text-red-500'"
            ></i>
            <span [class]="isDeviceBridgeConnected ? 'text-green-500' : 'text-red-500'">
              {{ isDeviceBridgeConnected ? 'Connected' : 'Disconnected' }}
            </span>
          </div>

          <div class="current-weight">
            <div class="weight-display">
              <span class="weight-number">{{ liveWeight || 0 | number : '1.2-2' }}</span>
              <span class="weight-unit">kg</span>
            </div>
            <div class="weight-status">
              <i
                class="pi"
                [class]="
                  isWeightStable
                    ? 'pi-check-circle text-green-500'
                    : 'pi-exclamation-triangle text-orange-500'
                "
              ></i>
              <span>{{ isWeightStable ? 'Stable' : 'Unstable' }}</span>
            </div>
          </div>

          <div class="weight-info">
            <div class="info-row">
              <label>Last Update:</label>
              <span>{{ liveWeight ? 'Just now' : 'No data' }}</span>
            </div>
            <div class="info-row">
              <label>Source:</label>
              <span>Weighbridge {{ isDeviceBridgeConnected ? '1' : '-' }}</span>
            </div>
          </div>
        </div>
      </p-card>

      <!-- Progress Card -->
      <p-card header="Progress" class="mt-3">
        <div class="progress-info">
          <div class="progress-stats">
            <span
              >{{ loadedItemsCount + skippedItemsCount }} of {{ totalItemsCount }} items
              processed</span
            >
          </div>
          <p-progressBar [value]="progressPercentage" [showValue]="true"></p-progressBar>
        </div>
      </p-card>
    </div>

    <!-- Right Side: Current Step Form -->
    <div class="right-panel">
      <!-- Step 1: Gate Entry -->
      @if (processing.currentStep === 'gate_entry' && isInProgress) {
      <p-card header="Step 1: Gate Entry">
        <p class="step-description">
          Record truck arrival details and assign RFID card to the driver.
        </p>

        <!-- RFID Card Assignment Section (only show if user has permission) -->
        @if (canAssignRfid) {
        <div class="rfid-inline-section">
          <h4 class="rfid-section-title"><i class="pi pi-wifi"></i> RFID Card (Optional)</h4>
          @if (availableRfidCards.length > 0) {
          <div class="rfid-input-group">
            <div class="rfid-scan-field">
              <label for="rfidScan">Scan or Enter Card Number</label>
              <div class="scan-input-wrapper">
                <i class="pi pi-wifi scan-icon"></i>
                <input
                  pInputText
                  id="rfidScan"
                  [(ngModel)]="rfidScanInput"
                  [ngModelOptions]="{ standalone: true }"
                  placeholder="Scan RFID card here..."
                  (keydown.enter)="onRfidScanEnter($event)"
                  (input)="onRfidInputChange()"
                  class="scan-input"
                />
                @if (rfidScanInput) {
                <button type="button" class="clear-btn" (click)="clearRfidSelection()">
                  <i class="pi pi-times"></i>
                </button>
                }
              </div>
            </div>
            <div class="rfid-or-divider">OR</div>
            <div class="rfid-select-field">
              <label for="rfidCard">Select from List</label>
              <p-select
                id="rfidCard"
                [(ngModel)]="gateEntryData.rfidCardNumber"
                [ngModelOptions]="{ standalone: true }"
                [options]="availableRfidCards"
                optionLabel="label"
                optionValue="cardNumber"
                placeholder="Choose a card"
                [showClear]="true"
                (ngModelChange)="onRfidDropdownChange($event)"
                class="w-full"
              >
                <ng-template pTemplate="item" let-card>
                  <div class="rfid-option">
                    <span class="card-label">{{ card.label || card.cardNumber }}</span>
                    <span class="card-number-small">{{ card.cardNumber }}</span>
                  </div>
                </ng-template>
              </p-select>
            </div>
          </div>
          @if (selectedRfidCardLabel) {
          <div class="rfid-selected-info">
            <i class="pi pi-check-circle"></i>
            <span
              >Selected: <strong>{{ selectedRfidCardLabel }}</strong></span
            >
          </div>
          }
          <small class="rfid-hint">
            <i class="pi pi-info-circle"></i>
            Assign an RFID card to quickly access this DO by scanning at any step
          </small>
          } @else {
          <div class="rfid-no-cards">
            <i class="pi pi-info-circle"></i>
            <span
              >No RFID cards available. Create cards in <strong>RFID Cards</strong> menu
              first.</span
            >
          </div>
          }
        </div>
        }

        <div class="step-form">
          <div class="form-grid">
            <div class="form-field">
              <label for="vehicleNo">Vehicle Number *</label>
              <input
                pInputText
                id="vehicleNo"
                [(ngModel)]="gateEntryData.vehicleNo"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Enter vehicle number"
                required
              />
            </div>

            <div class="form-field">
              <label for="driverName">Driver Name</label>
              <input
                pInputText
                id="driverName"
                [(ngModel)]="gateEntryData.driverName"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Enter driver name"
              />
            </div>

            <div class="form-field">
              <label for="driverPhone">Driver Phone</label>
              <input
                pInputText
                id="driverPhone"
                [(ngModel)]="gateEntryData.driverPhone"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Enter driver phone"
              />
            </div>

            <div class="form-field">
              <label for="driverLicense">Driver License</label>
              <input
                pInputText
                id="driverLicense"
                [(ngModel)]="gateEntryData.driverLicense"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Enter driver license"
              />
            </div>

            <div class="form-field">
              <label for="transporter">Transporter</label>
              <p-select
                id="transporter"
                [options]="transporters"
                [(ngModel)]="gateEntryData.transporterId"
                [ngModelOptions]="{ standalone: true }"
                optionLabel="transporterName"
                optionValue="id"
                placeholder="Select transporter"
                [showClear]="true"
                [filter]="true"
                filterPlaceholder="Search transporters..."
                class="w-full"
              ></p-select>
            </div>

            <div class="form-field full-width">
              <label for="gateRemarks">Remarks</label>
              <textarea
                pInputTextarea
                id="gateRemarks"
                [(ngModel)]="gateEntryData.remarks"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Any remarks..."
                rows="3"
              >
              </textarea>
            </div>
          </div>

          <div class="form-actions">
            <p-button
              label="Record Gate Entry"
              icon="pi pi-check"
              [loading]="submitting"
              [disabled]="!gateEntryData.vehicleNo"
              (click)="submitGateEntry()"
            >
            </p-button>
          </div>
        </div>
      </p-card>
      }

      <!-- Step 2: Initial Weighing -->
      @if (processing.currentStep === 'initial_weighing' && isInProgress) {
      <p-card header="Step 2: Initial Weighing">
        <p class="step-description">
          Record initial tare weight at Weighbridge-1 and capture photos.
        </p>

        <div class="step-form">
          <div class="form-grid">
            <div class="form-field">
              <label for="initialWeight">Initial Tare Weight (kg) *</label>
              <div class="weight-input-group">
                <p-inputNumber
                  id="initialWeight"
                  [(ngModel)]="initialWeighingData.initialTareWeight"
                  [ngModelOptions]="{ standalone: true }"
                  [minFractionDigits]="2"
                  [maxFractionDigits]="2"
                  placeholder="0.00"
                >
                </p-inputNumber>
                <p-button
                  label="Refresh Live Weight"
                  icon="pi pi-refresh"
                  severity="success"
                  [text]="true"
                  (click)="useLiveWeightForInitial()"
                  pTooltip="Update with current weighbridge reading"
                >
                </p-button>
              </div>
              <small class="weight-hint">
                <i class="pi pi-info-circle"></i>
                Live weight is used by default. Current: {{ liveWeight || 0 | number : '1.2-2' }} kg
                <span [class]="isWeightStable ? 'stable' : 'unstable'">
                  ({{ isWeightStable ? 'Stable' : 'Unstable' }})
                </span>
              </small>
            </div>

            <div class="form-field">
              <label for="weighbridgeId">Weighbridge</label>
              <input
                pInputText
                id="weighbridgeId"
                [(ngModel)]="initialWeighingData.weighbridgeId"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Weighbridge ID"
                value="1"
                readonly
              />
            </div>
          </div>

          <!-- Live Weight Display for Step 2 -->
          <div class="live-weight-section">
            <div class="section-header">
              <h5>Current Weighbridge Reading</h5>
              <div class="connection-status">
                <i
                  class="pi"
                  [class]="
                    isDeviceBridgeConnected ? 'pi-wifi text-green-500' : 'pi-wifi text-red-500'
                  "
                ></i>
                <span [class]="isDeviceBridgeConnected ? 'text-green-500' : 'text-red-500'">
                  {{ isDeviceBridgeConnected ? 'Connected' : 'Disconnected' }}
                </span>
              </div>
            </div>
            <div class="weight-display">
              <div class="weight-value">
                <span class="weight-number">{{ liveWeight || 0 | number : '1.2-2' }}</span>
                <span class="weight-unit">kg</span>
              </div>
              <div class="weight-status">
                <i
                  class="pi"
                  [class]="
                    isWeightStable
                      ? 'pi-check-circle text-green-500'
                      : 'pi-exclamation-triangle text-orange-500'
                  "
                ></i>
                <span>{{ isWeightStable ? 'Stable' : 'Unstable' }}</span>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <p-button
              label="Record Initial Weight"
              icon="pi pi-check"
              [loading]="submitting"
              [disabled]="!initialWeighingData.initialTareWeight || !isWeightStable"
              (click)="submitInitialWeighing()"
              pTooltip="Weight must be stable to record"
            >
            </p-button>
          </div>
        </div>
      </p-card>
      }

      <!-- Step 3: Item Loading -->
      @if (processing.currentStep === 'item_loading' && isInProgress) {
      <p-card header="Step 3-7: Item Loading">
        <p class="step-description">
          Load items one by one sequentially. After loading each item, weigh the truck to calculate
          the item's net weight.
        </p>

        <!-- Current Truck Weight Display -->
        <div class="truck-weight-display">
          <h5>Current Truck Weight</h5>
          <div class="weight-info">
            <div class="weight-item">
              <label>Initial Tare Weight:</label>
              <span>{{ +(processing.initialTareWeight ?? 0) | number : '1.2-2' }} kg</span>
            </div>
            <div class="weight-item">
              <label>Loaded Items Weight:</label>
              <span>{{ +(processing.totalLoadedWeight ?? 0) | number : '1.2-2' }} kg</span>
            </div>
            <div class="weight-item highlight">
              <label>Current Truck Weight:</label>
              <span>{{ getCurrentTruckWeight() | number : '1.2-2' }} kg</span>
            </div>
          </div>
        </div>

        <!-- Items Loading Progress -->
        <div class="items-section">
          <h4>
            Items Loading Progress ({{ loadedItemsCount }} of {{ totalItemsCount }} completed)
          </h4>

          @for (item of processing.items; track item.id) {
          <div class="item-card" [class]="'status-' + item.loadingStatus">
            <div class="item-header">
              <div class="item-info">
                <span class="item-name">{{ item.materialName || 'Unknown Material' }}</span>
                <span class="item-code">{{ item.materialCode || '' }}</span>
              </div>
              <div class="item-status">
                <p-tag
                  [severity]="getItemStatusSeverity(item.loadingStatus)"
                  [value]="getItemStatusLabel(item.loadingStatus)"
                >
                </p-tag>
              </div>
            </div>

            <div class="item-details">
              <div class="item-qty">
                <label>Ordered Quantity:</label>
                <span>{{ +(item.orderedQuantity ?? 0) | number : '1.2-2' }} units</span>
              </div>
              @if (item.tareWeightWb2) {
              <div class="item-weight">
                <label>Tare Weight:</label>
                <span>{{ +item.tareWeightWb2 | number : '1.2-2' }} kg</span>
              </div>
              } @if (item.grossWeightWb2) {
              <div class="item-weight">
                <label>Gross Weight:</label>
                <span>{{ +item.grossWeightWb2 | number : '1.2-2' }} kg</span>
              </div>
              } @if (item.loadedWeight) {
              <div class="item-weight highlight">
                <label>Net Weight:</label>
                <span>{{ +item.loadedWeight | number : '1.2-2' }} kg</span>
              </div>
              }
            </div>

            <!-- Item Actions -->
            <div class="item-actions">
              @if (item.loadingStatus === 'pending' && item === getNextItemToLoad() &&
              !getCurrentLoadingItem()) {
              <p-button
                label="Mark as Loaded"
                icon="pi pi-check"
                severity="success"
                size="small"
                (click)="markItemAsLoaded(item)"
                pTooltip="Mark this item as physically loaded into the truck"
              >
              </p-button>
              } @else if (item.loadingStatus === 'loading' && getCurrentLoadingItem() && item ===
              getCurrentLoadingItem()) {
              <div class="weight-recording-interface">
                <div class="loading-status">
                  <p><strong>✓ Item Loaded - Record Truck Weight</strong></p>
                  <p>Drive truck to weighbridge and record the current weight</p>
                </div>

                <div class="weight-calculation-display">
                  <div class="calc-row">
                    <label>Tare Weight (before loading):</label>
                    <span>{{ getCurrentTruckWeight() | number : '1.2-2' }} kg</span>
                  </div>
                  <div class="calc-row current">
                    <label>Current Truck Weight:</label>
                    <span class="live-weight">{{ liveWeight || 0 | number : '1.2-2' }} kg</span>
                    <span [class]="isWeightStable ? 'weight-stable' : 'weight-unstable'">
                      {{ isWeightStable ? '✓ Stable' : '⚠ Unstable' }}
                    </span>
                  </div>
                  <div class="calc-row result">
                    <label>Item Net Weight:</label>
                    <span class="net-weight"
                      >{{ (liveWeight || 0) - getCurrentTruckWeight() | number : '1.2-2' }} kg</span
                    >
                  </div>
                </div>

                <div class="record-actions">
                  <p-button
                    label="Record Weight"
                    icon="pi pi-check-circle"
                    severity="success"
                    [disabled]="!isWeightStable || !liveWeight"
                    (click)="recordCurrentTruckWeight()"
                    [loading]="submitting"
                    pTooltip="Weight must be stable to record"
                  >
                  </p-button>
                </div>
              </div>
              }
            </div>
          </div>
          }
        </div>

        <!-- Current Item Loading - Must Record Weight First -->
        @if (getCurrentLoadingItem()) {
        <div class="current-loading-notice">
          <i class="pi pi-exclamation-triangle text-orange-500"></i>
          <div>
            <h5>Record Weight Before Loading Next Item</h5>
            <p>
              You must record the weight for
              <strong>{{ getCurrentLoadingItem()?.materialName }}</strong> before loading the next
              item.
            </p>
          </div>
        </div>
        }

        <!-- Next Item Instructions -->
        @if (getNextItemToLoad() && !getCurrentLoadingItem()) {
        <div class="next-item-instructions">
          <h5>Next Item to Load</h5>
          <p>
            <strong>{{ getNextItemToLoad()?.materialName }}</strong>
          </p>
          <p>
            Quantity: {{ +(getNextItemToLoad()?.orderedQuantity ?? 0) | number : '1.2-2' }} units
          </p>
          <p>Click "Mark as Loaded" when the item is physically loaded into the truck.</p>
        </div>
        }

        <!-- All Items Completed -->
        @if (loadedItemsCount === totalItemsCount) {
        <div class="completion-message">
          <i class="pi pi-check-circle text-green-500"></i>
          <h5>All Items Loaded Successfully!</h5>
          <p>You can now proceed to final weighing.</p>
        </div>
        }
      </p-card>
      }

      <!-- Step 4: Final Weighing -->
      @if (processing.currentStep === 'final_weighing' && isInProgress) {
      <p-card header="Step 8: Final Weighing">
        <p class="step-description">
          Record final gross weight at Weighbridge-1 to complete the process.
        </p>

        <div class="step-form">
          <div class="form-grid">
            <div class="form-field">
              <label for="finalWeight">Final Gross Weight (kg) *</label>
              <div class="weight-input-group">
                <p-inputNumber
                  id="finalWeight"
                  [(ngModel)]="finalWeighingData.finalGrossWeight"
                  [ngModelOptions]="{ standalone: true }"
                  [minFractionDigits]="2"
                  [maxFractionDigits]="2"
                  placeholder="0.00"
                >
                </p-inputNumber>
                <p-button
                  label="Use Live Weight"
                  icon="pi pi-refresh"
                  [text]="true"
                  (click)="useLiveWeightForFinal()"
                >
                </p-button>
              </div>
            </div>

            <div class="form-field">
              <label for="finalWeighbridgeId">Weighbridge</label>
              <input
                pInputText
                id="finalWeighbridgeId"
                [(ngModel)]="finalWeighingData.weighbridgeId"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Weighbridge ID"
                value="1"
                readonly
              />
            </div>

            <div class="form-field full-width">
              <label for="finalRemarks">Final Remarks</label>
              <textarea
                pInputTextarea
                id="finalRemarks"
                [(ngModel)]="finalWeighingData.remarks"
                [ngModelOptions]="{ standalone: true }"
                placeholder="Any final remarks..."
                rows="3"
              >
              </textarea>
            </div>
          </div>

          <div class="form-actions">
            <p-button
              label="Complete Processing"
              icon="pi pi-check-circle"
              [loading]="submitting"
              [disabled]="!finalWeighingData.finalGrossWeight"
              (click)="submitFinalWeighing()"
            >
            </p-button>
          </div>
        </div>
      </p-card>
      }

      <!-- Step 5: Completed -->
      @if (processing.currentStep === 'completed' || isCompleted) {
      <p-card header="Processing Completed">
        <div class="completion-summary">
          <div class="completion-icon">
            <i class="pi pi-check-circle text-green-500"></i>
          </div>
          <h3>DO Processing Completed Successfully!</h3>
          <p>The delivery order has been processed and all weights have been recorded.</p>

          <div class="final-summary">
            <div class="summary-item">
              <label>Completion Time:</label>
              <span>{{ processing.completedTime | date : 'medium' }}</span>
            </div>
            <div class="summary-item">
              <label>Items Processed:</label>
              <span>{{ loadedItemsCount }} loaded, {{ skippedItemsCount }} skipped</span>
            </div>
            <div class="summary-item">
              <label>Net Weight:</label>
              <span class="highlight"
                >{{ +(processing.netWeight ?? 0) | number : '1.2-2' }} kg</span
              >
            </div>
          </div>

          <div class="download-actions">
            <p-button
              label="Download PDF Report"
              icon="pi pi-download"
              severity="success"
              (click)="downloadPDF()"
            ></p-button>
          </div>
        </div>
      </p-card>

      <!-- Items Weight Summary -->
      <p-card header="Items Weight Summary" class="mt-3">
        <div class="items-summary-table">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-100">
                <th class="text-left p-3">Material</th>
                <th class="text-right p-3">Tare Weight (kg)</th>
                <th class="text-right p-3">Gross Weight (kg)</th>
                <th class="text-right p-3">Net Weight (kg)</th>
                <th class="text-center p-3">Status</th>
              </tr>
            </thead>
            <tbody>
              @for (item of processing.items; track item.id) {
              <tr class="border-t hover:bg-gray-50">
                <td class="p-3">
                  <div class="flex flex-col">
                    <span class="font-medium">{{ item.materialName || 'Unknown' }}</span>
                    <span class="text-sm text-gray-500">{{ item.materialCode || '' }}</span>
                  </div>
                </td>
                <td class="text-right p-3">
                  @if (item.tareWeightWb2) {
                  {{ +item.tareWeightWb2 | number : '1.2-2' }}
                  } @else { - }
                </td>
                <td class="text-right p-3">
                  @if (item.grossWeightWb2) {
                  {{ +item.grossWeightWb2 | number : '1.2-2' }}
                  } @else { - }
                </td>
                <td class="text-right p-3 font-semibold text-green-600">
                  @if (item.loadedWeight) {
                  {{ +item.loadedWeight | number : '1.2-2' }}
                  } @else { - }
                </td>
                <td class="text-center p-3">
                  <p-tag
                    [severity]="getItemStatusSeverity(item.loadingStatus)"
                    [value]="getItemStatusLabel(item.loadingStatus)"
                  ></p-tag>
                </td>
              </tr>
              }
            </tbody>
            <tfoot>
              <tr class="border-t-2 bg-gray-50 font-bold">
                <td class="p-3">Total</td>
                <td class="text-right p-3">
                  {{ +(processing.initialTareWeight ?? 0) | number : '1.2-2' }}
                </td>
                <td class="text-right p-3">
                  {{ +(processing.finalGrossWeight ?? 0) | number : '1.2-2' }}
                </td>
                <td class="text-right p-3 text-green-600">
                  {{ +(processing.totalLoadedWeight ?? 0) | number : '1.2-2' }}
                </td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </p-card>
      }

      <!-- Cancelled State -->
      @if (isCancelled) {
      <p-card header="Processing Cancelled">
        <div class="cancellation-info">
          <div class="cancellation-icon">
            <i class="pi pi-times-circle text-red-500"></i>
          </div>
          <h3>Processing was cancelled</h3>
          <p>{{ processing.remarks || 'No cancellation reason provided.' }}</p>
        </div>
      </p-card>
      }
    </div>
  </div>
  }
</div>
