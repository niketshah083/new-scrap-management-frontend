<div class="grn-detail">
  <div class="page-header">
    <div class="header-left">
      <p-button icon="pi pi-arrow-left" [text]="true" (click)="goBack()"></p-button>
      <h1>GRN Details</h1>
    </div>
    @if (grn && grn.status !== 'completed' && grn.status !== 'rejected') {
    <p-button label="Continue" icon="pi pi-arrow-right" (click)="continueGRN()"></p-button>
    }
  </div>

  @if (loading) {
  <div class="loading">Loading...</div>
  } @else if (grn) {
  <div class="grn-info">
    <p-card>
      <div class="info-grid">
        <div class="info-item">
          <label>GRN Number</label>
          <span>{{ grn.grnNumber }}</span>
        </div>
        <div class="info-item">
          <label>PO Number</label>
          <span>{{ grn.purchaseOrder?.poNumber || '-' }}</span>
        </div>
        <div class="info-item">
          <label>Vendor</label>
          <span>{{ grn.vendor?.companyName || '-' }}</span>
        </div>
        <div class="info-item">
          <label>Status</label>
          <p-tag
            [value]="grn.status | titlecase"
            [severity]="getStatusSeverity(grn.status)"
          ></p-tag>
        </div>
        <div class="info-item">
          <label>Current Step</label>
          <span>Step {{ grn.currentStep }} of 7</span>
        </div>
        <div class="info-item">
          <label>Created</label>
          <span>{{ grn.createdAt | date : 'medium' }}</span>
        </div>
      </div>
    </p-card>

    <p-card header="Step 1: Gate Entry" class="mt-4">
      <div class="info-grid">
        <div class="info-item">
          <label>Truck Number</label><span>{{ grn.truckNumber }}</span>
        </div>
        <!-- Dynamic field values from step 1 -->
        @for (fieldValue of getFieldValuesByStep(1); track fieldValue.id) {
        <div class="info-item">
          <label>{{ fieldValue.fieldConfig?.fieldLabel }}</label>
          <span>{{ fieldValue.textValue || fieldValue.numberValue || '-' }}</span>
        </div>
        }
      </div>
    </p-card>

    @if (getFieldValuesByStep(2).length > 0) {
    <p-card header="Step 2: Initial Weighing" class="mt-4">
      <div class="info-grid">
        @for (fieldValue of getFieldValuesByStep(2); track fieldValue.id) {
        <div class="info-item">
          <label>{{ fieldValue.fieldConfig?.fieldLabel }}</label>
          <span
            >{{ fieldValue.numberValue || fieldValue.textValue || '-'
            }}{{ fieldValue.fieldConfig?.fieldName?.includes('weight') ? ' kg' : '' }}</span
          >
        </div>
        }
      </div>
    </p-card>
    } @if (getFieldValuesByStep(3).length > 0) {
    <p-card header="Step 3: Unloading" class="mt-4">
      <div class="info-grid">
        @for (fieldValue of getFieldValuesByStep(3); track fieldValue.id) {
        <div class="info-item">
          <label>{{ fieldValue.fieldConfig?.fieldLabel }}</label>
          <span>{{ fieldValue.textValue || fieldValue.numberValue || '-' }}</span>
        </div>
        }
      </div>
    </p-card>
    } @if (getFieldValuesByStep(4).length > 0 || grn.netWeight) {
    <p-card header="Step 4: Final Weighing" class="mt-4">
      <div class="info-grid">
        @for (fieldValue of getFieldValuesByStep(4); track fieldValue.id) {
        <div class="info-item">
          <label>{{ fieldValue.fieldConfig?.fieldLabel }}</label>
          <span
            >{{ fieldValue.numberValue || fieldValue.textValue || '-'
            }}{{ fieldValue.fieldConfig?.fieldName?.includes('weight') ? ' kg' : '' }}</span
          >
        </div>
        } @if (grn.netWeight) {
        <div class="info-item">
          <label>Net Weight</label>
          <span style="color: #10b981; font-weight: bold">{{ grn.netWeight }} kg</span>
        </div>
        }
      </div>
    </p-card>
    } @if (grn.approvalStatus) {
    <p-card header="Step 5: Supervisor Review" class="mt-4">
      <div class="info-grid">
        <div class="info-item">
          <label>Verification Status</label>
          <p-tag
            [value]="(grn.verificationStatus | titlecase) || ''"
            [severity]="grn.verificationStatus === 'verified' ? 'success' : 'warn'"
          ></p-tag>
        </div>
        <div class="info-item">
          <label>Decision</label>
          <p-tag
            [value]="(grn.approvalStatus | titlecase) || ''"
            [severity]="grn.approvalStatus === 'approved' ? 'success' : 'danger'"
          ></p-tag>
        </div>
        @if (grn.reviewedAt) {
        <div class="info-item">
          <label>Reviewed At</label><span>{{ grn.reviewedAt | date : 'medium' }}</span>
        </div>
        } @if (grn.rejectionReason) {
        <div class="info-item full-width">
          <label>Rejection Reason</label><span>{{ grn.rejectionReason }}</span>
        </div>
        }
      </div>
    </p-card>
    }
  </div>
  }
</div>
